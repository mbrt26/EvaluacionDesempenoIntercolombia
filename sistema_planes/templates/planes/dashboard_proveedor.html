{% extends 'base.html' %}

{% block title %}Dashboard - {{ proveedor.razon_social }}{% endblock %}

{% block extra_css %}
<style>
    .stat-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .stat-card.blue { border-left-color: #3498db; }
    .stat-card.green { border-left-color: #27ae60; }
    .stat-card.orange { border-left-color: #f39c12; }
    .stat-card.red { border-left-color: #e74c3c; }
    .stat-card.purple { border-left-color: #9b59b6; }

    .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
    }

    .stat-label {
        color: #7f8c8d;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
        <p class="text-muted">Bienvenido, {{ proveedor.razon_social }}</p>
    </div>
</div>

<!-- Informaci√≥n del Proveedor -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="bi bi-building"></i> Informaci√≥n del Proveedor</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm table-borderless">
                    <tbody>
                        <tr>
                            <td><strong>NIT:</strong></td>
                            <td>{{ proveedor.nit }}</td>
                        </tr>
                        <tr>
                            <td><strong>Raz√≥n Social:</strong></td>
                            <td>{{ proveedor.razon_social }}</td>
                        </tr>
                        <tr>
                            <td><strong>Email:</strong></td>
                            <td>{{ proveedor.email }}</td>
                        </tr>
                        {% if proveedor.email_adicional %}
                        <tr>
                            <td><strong>Email Adicional:</strong></td>
                            <td>{{ proveedor.email_adicional }}</td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-bar-chart"></i> Estad√≠sticas Generales</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <div class="stat-number text-primary">{{ estadisticas.total_evaluaciones }}</div>
                        <div class="stat-label">Evaluaciones</div>
                    </div>
                    <div class="col-6 mb-3">
                        <div class="stat-number {% if estadisticas.promedio_puntaje >= 80 %}text-success{% elif estadisticas.promedio_puntaje >= 60 %}text-warning{% else %}text-danger{% endif %}">
                            {{ estadisticas.promedio_puntaje }}
                        </div>
                        <div class="stat-label">Prom. Puntaje</div>
                    </div>
                    <div class="col-6">
                        <div class="stat-number text-info">{{ estadisticas.total_planes }}</div>
                        <div class="stat-label">Planes Totales</div>
                    </div>
                    <div class="col-6">
                        <div class="stat-number text-success">{{ estadisticas.planes_aprobados }}</div>
                        <div class="stat-label">Planes Aprobados</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resumen de Evaluaciones -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card stat-card green">
            <div class="card-body text-center">
                <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                <div class="stat-number text-success">{{ estadisticas.evaluaciones_satisfactorias }}</div>
                <div class="stat-label">Satisfactorias (‚â•80)</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card orange">
            <div class="card-body text-center">
                <i class="bi bi-exclamation-circle text-warning" style="font-size: 3rem;"></i>
                <div class="stat-number text-warning">{{ estadisticas.evaluaciones_aceptables }}</div>
                <div class="stat-label">Aceptables (60-79)</div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card stat-card red">
            <div class="card-body text-center">
                <i class="bi bi-x-circle text-danger" style="font-size: 3rem;"></i>
                <div class="stat-number text-danger">{{ estadisticas.evaluaciones_criticas }}</div>
                <div class="stat-label">Cr√≠ticas (<60)</div>
            </div>
        </div>
    </div>
</div>

<!-- Estados de Planes -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Estado de Planes de Mejoramiento</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-2">
                        <div class="mb-2">
                            <span class="badge bg-secondary fs-4">{{ estadisticas.planes_borrador }}</span>
                        </div>
                        <small class="text-muted">Borrador</small>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <span class="badge bg-info fs-4">{{ estadisticas.planes_enviados }}</span>
                        </div>
                        <small class="text-muted">Enviados</small>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <span class="badge bg-warning fs-4">{{ estadisticas.planes_revision }}</span>
                        </div>
                        <small class="text-muted">En Revisi√≥n</small>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <span class="badge bg-danger fs-4">{{ estadisticas.planes_requiere_ajustes }}</span>
                        </div>
                        <small class="text-muted">Requiere Ajustes</small>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <span class="badge bg-success fs-4">{{ estadisticas.planes_aprobados }}</span>
                        </div>
                        <small class="text-muted">Aprobados</small>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <span class="badge bg-dark fs-4">{{ estadisticas.planes_rechazados }}</span>
                        </div>
                        <small class="text-muted">Rechazados</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historial de Evaluaciones -->
<div class="card mb-4">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0">
            <i class="bi bi-clock-history"></i> Historial de Evaluaciones
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>N¬∞ Contrato</th>
                        <th>Subcategor√≠a</th>
                        <th class="text-center">Puntaje</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center">Observaciones</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for evaluacion in evaluaciones %}
                    <tr>
                        <td>{{ evaluacion.fecha|date:"d/m/Y" }}</td>
                        <td>{{ evaluacion.numero_contrato|default:"‚Äî" }}</td>
                        <td>{{ evaluacion.subcategoria|default:"‚Äî" }}</td>
                        <td class="text-center">
                            <span class="badge {% if evaluacion.puntaje >= 80 %}bg-success{% elif evaluacion.puntaje >= 60 %}bg-warning text-dark{% else %}bg-danger{% endif %}" style="font-size: 1.1rem; padding: 0.5rem;">
                                {{ evaluacion.puntaje }}/100
                            </span>
                        </td>
                        <td class="text-center">{{ evaluacion.estado_evaluacion }}</td>
                        <td>{{ evaluacion.observaciones_generales|default:"‚Äî"|truncatewords:15 }}</td>
                        <td class="text-center">
                            <a href="{% url 'proveedor_ver_evaluacion' evaluacion.id %}" class="btn btn-info btn-sm">
                                <i class="bi bi-eye"></i> Ver
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div style="font-size: 48px;">üì≠</div>
                            <p class="text-muted">No hay evaluaciones registradas</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Planes de Mejoramiento -->
<div class="card">
    <div class="card-header bg-primary text-white">
        <h5 class="mb-0">
            <i class="bi bi-clipboard-check"></i> Planes de Mejoramiento
        </h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Evaluaci√≥n</th>
                        <th>N¬∞ Contrato</th>
                        <th>Fecha Creaci√≥n</th>
                        <th class="text-center">Estado</th>
                        <th class="text-center">Fecha L√≠mite</th>
                        <th class="text-center">√öltima Actualizaci√≥n</th>
                        <th class="text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for plan in planes %}
                    <tr>
                        <td>{{ plan.evaluacion.fecha|date:"d/m/Y" }}</td>
                        <td>{{ plan.evaluacion.numero_contrato|default:"‚Äî" }}</td>
                        <td>{{ plan.fecha_creacion|date:"d/m/Y" }}</td>
                        <td class="text-center">
                            {% if plan.estado == 'APROBADO' %}
                                <span class="badge bg-success">‚úì APROBADO</span>
                            {% elif plan.estado == 'RECHAZADO' %}
                                <span class="badge bg-dark">‚úó RECHAZADO</span>
                            {% elif plan.estado == 'ENVIADO' %}
                                <span class="badge bg-info">‚Üí ENVIADO</span>
                            {% elif plan.estado == 'EN_REVISION' %}
                                <span class="badge bg-warning">‚öô EN REVISI√ìN</span>
                            {% elif plan.estado == 'REQUIERE_AJUSTES' %}
                                <span class="badge bg-danger">! AJUSTES</span>
                            {% elif plan.estado == 'BORRADOR' %}
                                <span class="badge bg-secondary">üìù BORRADOR</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ plan.get_estado_display }}</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if plan.fecha_limite %}
                                <span class="{% if plan.esta_vencido %}text-danger fw-bold{% endif %}">
                                    {{ plan.fecha_limite|date:"d/m/Y" }}
                                </span>
                            {% else %}
                                ‚Äî
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if plan.fecha_aprobacion %}
                                <small class="text-muted">{{ plan.fecha_aprobacion|date:"d/m/Y H:i" }}</small>
                            {% elif plan.fecha_revision %}
                                <small class="text-muted">{{ plan.fecha_revision|date:"d/m/Y H:i" }}</small>
                            {% elif plan.fecha_envio %}
                                <small class="text-muted">{{ plan.fecha_envio|date:"d/m/Y H:i" }}</small>
                            {% else %}
                                <small class="text-muted">{{ plan.fecha_creacion|date:"d/m/Y H:i" }}</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <a href="{% url 'ver_plan' plan.id %}" class="btn btn-primary btn-sm">
                                <i class="bi bi-eye"></i> Ver
                            </a>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <div style="font-size: 48px;">üìã</div>
                            <p class="text-muted">No hay planes de mejoramiento registrados</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
